@model SysPres.Models.Prestamo
@{
    ViewData["Title"] = "Detalle Préstamo";
}

<div class="container-fluid py-3">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-4">
        <div>
            <h2 class="mb-1">Préstamo #@Model.Id</h2>
            <p class="text-muted mb-0">Cliente: @(Model.Cliente?.Nombre ?? "-")</p>
        </div>
        <div class="d-flex gap-2">
            <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-outline-secondary">Editar</a>
            <a asp-action="Index" class="btn btn-outline-primary">Volver</a>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-3"><div class="card shadow-sm"><div class="card-body"><small class="text-muted">Monto</small><div class="fw-bold">@Model.Monto.ToString("C")</div></div></div></div>
        <div class="col-md-3"><div class="card shadow-sm"><div class="card-body"><small class="text-muted">Interés</small><div class="fw-bold">@Model.MontoInteres.ToString("C")</div></div></div></div>
        <div class="col-md-3"><div class="card shadow-sm"><div class="card-body"><small class="text-muted">Total a pagar</small><div class="fw-bold">@Model.TotalAPagar.ToString("C")</div></div></div></div>
        <div class="col-md-3"><div class="card shadow-sm"><div class="card-body"><small class="text-muted">Saldo pendiente</small><div class="fw-bold">@Model.SaldoPendiente.ToString("C")</div></div></div></div>
    </div>

    <div class="card shadow-sm">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h6 class="mb-0">Cronograma de pagos (@Model.FrecuenciaPago)</h6>
            <span class="badge @(Model.Estado == "Saldado" ? "text-bg-success" : "text-bg-warning")">@Model.Estado</span>
        </div>
        <div class="table-responsive">
            <table class="table table-hover mb-0 align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Cuota</th>
                        <th>Fecha vencimiento</th>
                        <th>Monto</th>
                        <th>Pagado</th>
                        <th>Pendiente</th>
                        <th>Estado</th>
                        <th>Acción</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var c in Model.Cuotas.OrderBy(x => x.NumeroCuota))
                    {
                        <tr>
                            <td>@c.NumeroCuota</td>
                            <td>@c.FechaVencimiento.ToString("dd/MM/yyyy")</td>
                            <td>@c.MontoCuota.ToString("C")</td>
                            <td>@c.MontoPagado.ToString("C")</td>
                            <td>@Math.Max(0, c.MontoCuota - c.MontoPagado).ToString("C")</td>
                            <td>
                                <span class="badge @(c.Estado == "Pagado" ? "text-bg-success" : c.Estado == "Parcial" ? "text-bg-warning" : "text-bg-secondary")">@c.Estado</span>
                            </td>
                            <td>
                                @if (c.Estado != "Pagado")
                                {
                                    <form method="post" asp-action="MarcarCuotaPagada" class="d-inline">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="prestamoId" value="@Model.Id" />
                                        <input type="hidden" name="cuotaId" value="@c.Id" />
                                        <button type="submit" class="btn btn-sm btn-outline-success">Marcar pagada</button>
                                    </form>
                                }
                                else
                                {
                                    <span class="text-muted small">Pagada @c.FechaPago?.ToString("dd/MM/yyyy")</span>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        <div class="card-footer bg-white">
            <form method="post" asp-action="ReestructurarSoloInteres" asp-route-id="@Model.Id" class="mb-3" onsubmit="return confirm('Esto registrará un pago SOLO INTERÉS y reiniciará el préstamo al próximo ciclo. ¿Continuar?');">
                @Html.AntiForgeryToken()
                <button type="submit" class="btn btn-outline-warning" @(Model.Estado == "Saldado" ? "disabled" : null)>Reestructurar (pago solo interés)</button>
                <small class="text-muted ms-2">Usa esta opción cuando el cliente pagó solo interés y el capital se reinicia al próximo ciclo.</small>
            </form>
            <form method="post" asp-action="Delete" asp-route-id="@Model.Id" onsubmit="return confirm('Solo se eliminará si está saldado. ¿Continuar?');">
                @Html.AntiForgeryToken()
                <button type="submit" class="btn btn-outline-danger" @(Model.Estado != "Saldado" ? "disabled" : null)>Eliminar préstamo</button>
                <small class="text-muted ms-2">Solo habilitado para préstamos saldados.</small>
            </form>
        </div>
    </div>
</div>
